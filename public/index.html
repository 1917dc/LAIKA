<!DOCTYPE html>
<html lang="pt-br">

<head>
    <!-- <meta charset="ISO 8859-1">-->
    <meta charset="UTF-8">
    <meta property="og:title" content="Hermes Express">
    <meta property="og:description" content="Hermes Express - Consórcio ágil para você!">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Consórcio</title>
    <link rel="icon" type="image/png" href="./img/favicon.png" />

    <!-- CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        /* Reset */
        * {
            margin: 0;
            padding: 0;
        }

        body {
            margin: 5px;
        }
        .prevent-select{
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body>
    <div class="container mt-2">
        <!-- Header -->
        <div class="row mb-4 mt-4">
            <div class="col-6">
                <h3 class="prevent-select">Relat�rio de Vendas</h3>
            </div>

            <div class="col-6 text-right">
                <button id="btnAdicionar" type="button" class="btn btn-dark">+ Adicionar Venda</button>
            </div>
            
        </div>
        <!-- Tabela -->
        <table class="table table-hover table-dark">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Cargo</th>
                    <th>C�digo do Vendedor</th>
                    <th>Valor de Venda</th>
                    <th>C�digo de Venda</th>
                    <th>A��es</th>
                </tr>
            </thead>
            <tbody id="vendasBody">
                <!-- <tr>
                        <td>Fulano</td>
                        <td>senior</td>
                        <td>001</td>
                        <td>999.99</td>
                        <td>1%</td>
                        <td>Editar/excluir</td>
                    </tr> -->
            </tbody>
        </table>
        <div class="text-center">
            <button type="button" id="gerarBtn" class="btn btn-dark m-5" onclick="sortVendas(), window.open('./relatorio.html')">Gerar Relat�rio</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modalAdicionarContato" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Nova Venda</h5>
                    <button type="button" class="close" id="closeModal">&times;</button>
                </div>

                <div class="modal-body ">
                    <form id="formAdicionarVenda">
                        <div class="form-group">
                            <label for="nomeVendedor">Nome:</label>
                            <input type="text" class="form-control" id="nomeVendedor" required>
                        </div>
                        <div class="form-group">
                            <label for="cargoVendedor">Cargo:</label>
                            <input type="text" class="form-control" id="cargoVendedor" required>
                        </div>
                        <div class="form-group">
                            <label for="codVendedor">C�digo do Vendedor:</label>
                            <input type="number" class="form-control" id="codVendedor" required>
                        </div>
                        <div class="form-group">
                            <label for="valorVenda">Valor de venda:</label>
                            <input type="number" class="form-control" id="valorVenda" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="codVenda">C�digo de Venda:</label>
                            <input type="number" class="form-control" id="codVenda" required>
                        </div>
                        <!-- Dispara o evento 'submit', pode ser resgatado no JS -->
                        <button type="submit" onclick="adicionarContato(event)" class="btn btn-dark">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

        <!-- Modal -->
        <div id="modalEditarContato" class="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Venda</h5>
                        <button type="button" class="close" id="closeModalEditar">&times;</button>
                    </div>
    
                    <div class="modal-body ">
                        <form id="formEditarVenda">
                            <div class="form-group">
                                <label for="nomeEditar">Nome:</label>
                                <input type="text" class="form-control" id="nomeEditar" required>
                            </div>
                            <div class="form-group">
                                <label for="cargoEditar">Cargo:</label>
                                <input type="text" class="form-control" id="cargoEditar" required>
                            </div>
                            <div class="form-group">
                                <label for="codVendedorEditar">C�digo do Vendedor:</label>
                                <input type="number" class="form-control" id="codVendedorEditar" required>
                            </div>
                            <div class="form-group">
                                <label for="valorVendaEditar">Valor de venda:</label>
                                <input type="number" class="form-control" id="valorVendaEditar" step="any" required>
                            </div>
                            <div class="form-group">
                                <label for="codVendaEditar">C�digo de Venda:</label>
                                <input type="number" class="form-control" id="codVendaEditar" required>
                            </div>
                            <!-- Dispara o evento 'submit', pode ser resgatado no JS -->
                            <button type="submit" class="btn btn-dark">Salvar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    <!----------------------------- OVERLAY ----------------------------------->
    <!-- position: fixed define a origem do bloco, que ocupar� a tela inteira (0, 0) -->
    <div id="overlay" style="
            height: 100%;
            width: 100%;
            background-color: rgb(0, 0, 0, 0.5);
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2;"></div>

    <script>

        let vendasSorted= []; // array de vendas tratado
        let vendas = []; // array que armazena as vendas

        const minhaModalEditar = document.getElementById('modalEditarContato')
        const btnEditar = document.getElementById('editarDados');
        const btnFecharEditar = document.getElementById('closeModalEditar')
        const formEditarVenda = document.getElementById('formEditarVenda');

        const minhaModal = document.getElementById("modalAdicionarContato");
        const btnAdicionar = document.getElementById("btnAdicionar");
        const btnFechar = document.getElementById("closeModal");
        const formAdicionarVenda = document.getElementById('formAdicionarVenda')

        const overlay = document.getElementById("overlay");
        const gerarBtn = document.getElementById('gerarBtn');

        function renderizarTabela() {
            let vendasBody = document.getElementById('vendasBody')
            vendasBody.innerHTML = '' // Limpa a tabela

            vendas.forEach((venda, index) => {
                venda.valorVenda = parseFloat(venda.valorVenda)
                valorVendaFormatado = venda.valorVenda.toLocaleString('pt-BR', {
                    style: 'currency', currency: 'BRL'
                })
                venda.codVenda = venda.codVenda.toString();
                venda.codVendedor = venda.codVendedor.toString();

                venda.codVendedor = venda.codVendedor.padStart(3, '0')
                venda.codVenda = venda.codVenda.padStart(3, '0')

                if(venda.cargoVendedor === 'junior' || venda.cargoVendedor === 'Junior' || venda.cargoVendedor === 'J�nior'){
                    venda.cargo = 'J�nior'
                } else if(venda.cargoVendedor === 'pleno' || venda.cargoVendedor === 'Pleno'){
                    venda.cargoVendedor = 'Pleno'
                } else{venda.cargoVendedor = 'S�nior'}

                vendasBody.innerHTML += `
                    <tr>
                        <td>${venda.nomeVendedor}</td>
                        <td>${venda.cargoVendedor}</td>
                        <td>${venda.codVendedor}</td>
                        <td>${valorVendaFormatado}</td>
                        <td>${venda.codVenda}</td>
                        <td style="display: flex">
                            <button type="button" class="btn btn-light btn-sm text-center" onclick="overlay.style.display = 'block', editarVenda(${index})">
                                Editar
                            </button>

                            <button type="button" class="btn btn-light btn-sm text-center ml-2" onclick="excluirDados(${index})">
                                Excluir
                            </button>
                        </td>
                    </tr>
                    `
            })
        }

        function adicionarContato(event){
            event.preventDefault()

            // Armazenar os valores dos campos de input
            let nomeVendedor = document.getElementById('nomeVendedor').value;
            let cargoVendedor = document.getElementById('cargoVendedor').value;
            let codVendedor = document.getElementById('codVendedor').value;
            let valorVenda = document.getElementById('valorVenda').value;
            let codVenda = document.getElementById('codVenda').value;

            const venda = {nomeVendedor, cargoVendedor, codVendedor, valorVenda, codVenda}

            fetch('http://localhost:5000/vendas', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(venda)
            }).then(() => {
                    buscarVendas()
            })
            toggleModal(minhaModal)
            formAdicionarVenda.reset()
        }  

        function editarVenda(index){
            const venda = vendas[index]
            toggleModal(minhaModalEditar)

            document.getElementById('nomeEditar').value = venda.nomeVendedor 
            document.getElementById('cargoEditar').value = venda.cargoVendedor
            document.getElementById('codVendedorEditar').value = venda.codVendedor
            document.getElementById('valorVendaEditar').value = venda.valorVenda
            document.getElementById('codVendaEditar').value = venda.codVenda

            formEditarVenda.addEventListener('submit', function(event){
                event.preventDefault()

                const novaVenda = {
                    nomeVendedor: document.getElementById('nomeEditar').value,
                    cargoVendedor: document.getElementById('cargoEditar').value,
                    codVendedor: document.getElementById('codVendedorEditar').value,
                    valorVenda: document.getElementById('valorVendaEditar').value,
                    codVenda: document.getElementById('codVendaEditar').value,
                }

                fetch(`http://localhost:5000/vendas/${venda.nomeVendedor}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novaVenda)
                }).then(() => {
                    buscarVendas()
                })

                toggleModal(minhaModalEditar)
                formEditarVenda.reset();
            })
        }

        function excluirDados(index){
            fetch(`http://localhost:5000/vendas/${vendas[index].nomeVendedor}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                }).then(() => {
                    buscarVendas()
                })

            renderizarTabela()
        }

        //fun��o que comunica o front-end com o back-end.
        function buscarVendas(){
            fetch('http://localhost:5000/vendas')
                .then(response => response.json())
                .then(dados => {
                    vendas = dados
                    renderizarTabela()
                })
        }

        function sortVendas(){
            let codVendasRepetidas = []
            let vendedores = []
            vendedor = {}

            // como fazer? 
                // verificar se a pessoa j� foi adicionada, se n�o foi, adicionar
                // criar um objeto de vendedor, para adicionar na checagem
                // usar .includes para verificar
            vendas.forEach(venda =>{
                if(codVendasRepetidas.includes(venda.codVendedor)){
                vendedores.forEach(vendedor =>{
                    if(venda.nomeVendedor === vendedor.nome){
                        vendedor.totalVendas += venda.valorVenda
                        if(venda.valorVenda > vendedor.maiorVenda){
                            vendedor.maiorVenda = venda.valorVenda
                        }

                        if(vendedor.cargo === 'J�nior'){
                            vendedor.comissao = vendedor.totalVendas * 0.01
                        }else if(vendedor.cargo === 'Pleno'){
                            vendedor.comissao = vendedor.totalVendas * 0.02
                        }else if(vendedor.cargo === 'S�nior'){
                            vendedor.comissao = vendedor.totalVendas * 0.03
                        }
                    }
                })
                } else{
                    let nome = venda.nomeVendedor
                    let cargo = venda.cargoVendedor
                    let totalVendas = parseFloat(venda.valorVenda)
                    let maiorVenda = parseFloat(venda.valorVenda)

                    if(cargo === 'J�nior'){
                        comissao = totalVendas * 0.01
                    }else if(cargo === 'Pleno'){
                        comissao = totalVendas * 0.02
                    }else{
                        comissao = totalVendas * 0.03
                    }  
                    vendedor = {nome, cargo, totalVendas, maiorVenda, comissao}

                    vendedores.push(vendedor)
                    codVendasRepetidas.push(venda.codVendedor);
                }
            })
            console.log(vendedores)
            console.log(localStorage)
            localStorage.setItem('vendas',JSON.stringify(vendedores));
            
        }

        function toggleModal(modal) {
            const isModal = modal.style.display === 'block'

            modal.style.display = isModal ? 'none' : 'block'
            overlay.style.display = isModal ? 'none' : 'block'
        }

        
        // Ouvidor de evento de clique dos bot�es
        btnAdicionar.addEventListener("click", function () {
            toggleModal(minhaModal);
        });

        btnFechar.addEventListener("click", function () {
            toggleModal(minhaModal);
        });

        document.addEventListener('DOMContentLoaded', buscarVendas);

        btnFecharEditar.addEventListener("click", function() {
            toggleModal(minhaModalEditar)
        })
    </script>
</body>

</html>